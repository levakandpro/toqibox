# üé¨ –°–µ—Ä–≤–µ—Ä–Ω—ã–π MP4 –≠–∫—Å–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ FFmpeg

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π pipeline —ç–∫—Å–ø–æ—Ä—Ç–∞ MP4 –≤–∏–¥–µ–æ –∏–∑ Studio –ø—Ä–æ–µ–∫—Ç–æ–≤ (–∞—É–¥–∏–æ + —Ñ–æ—Ç–æ) —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π FFmpeg –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

---

## üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–º–µ—Ç "–≠–ö–°–ü–û–†–¢"**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ –∞—É–¥–∏–æ + —Ñ–æ—Ç–æ
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∞–∫—Å 4 –º–∏–Ω—É—Ç—ã)

### 2. **–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä**
- `POST /api/export` —Å FormData:
  - `audio` (File/Blob)
  - `photo` (File/Blob)
  - `duration` (—Å–µ–∫—É–Ω–¥—ã)
  - `plan` (`free` | `premium`)

### 3. **–°–µ—Ä–≤–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç**
- –°–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É `tmp/toqibox-exports/{jobId}/`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∞–π–ª—ã
- –ó–∞–ø—É—Å–∫–∞–µ—Ç FFmpeg:
  ```bash
  ffmpeg -loop 1 -i photo.jpg -i audio.mp3 \
    -c:v libx264 -tune stillimage \
    -c:a aac -b:a 192k \
    -pix_fmt yuv420p \
    -vf "scale=1280:720" \  # –∏–ª–∏ 1920:1080 –¥–ª—è premium
    -t {duration} \
    -movflags +faststart \
    output.mp4
  ```

### 4. **–û—á–µ—Ä–µ–¥—å**
- –ú–∞–∫—Å–∏–º—É–º **2 —ç–∫—Å–ø–æ—Ä—Ç–∞** –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤ –æ—á–µ—Ä–µ–¥–∏ `queued`

### 5. **Polling —Å—Ç–∞—Ç—É—Å–∞**
- –ö–ª–∏–µ–Ω—Ç –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `GET /api/export?jobId={id}`
- –°—Ç–∞—Ç—É—Å—ã: `queued` ‚Üí `processing` ‚Üí `completed` | `failed`

### 6. **–°–∫–∞—á–∏–≤–∞–Ω–∏–µ**
- `GET /api/export/download?jobId={id}`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π `output.mp4`
- –ü–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: **–∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ** –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (—á–µ—Ä–µ–∑ 5 —Å–µ–∫)

---

## üìê –õ–∏–º–∏—Ç—ã

| –ü–ª–∞–Ω | –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ | –ú–∞–∫—Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –ë–∏—Ç—Ä–µ–π—Ç –∞—É–¥–∏–æ |
|------|-----------|-------------------|---------------|
| **Free** | 1280x720 | 4 –º–∏–Ω—É—Ç—ã (240—Å) | 192k AAC |
| **Premium** | 1920x1080 | 4 –º–∏–Ω—É—Ç—ã (240—Å) | 192k AAC |

**–¢–∞–π–º–∞—É—Ç—ã:**
- –≠–∫—Å–ø–æ—Ä—Ç: 10 –º–∏–Ω—É—Ç
- Polling: 15 –º–∏–Ω—É—Ç

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
functions/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ export.js           # –û—Å–Ω–æ–≤–Ω–æ–π endpoint (POST/GET)
‚îÇ   ‚îî‚îÄ‚îÄ export/
‚îÇ       ‚îî‚îÄ‚îÄ download.js     # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–≥–æ MP4

src/
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îî‚îÄ‚îÄ studio/
‚îÇ       ‚îî‚îÄ‚îÄ StudioDesktop.jsx  # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞
‚îî‚îÄ‚îÄ styles/
    ‚îî‚îÄ‚îÄ export-loader.css      # –ö—Ä–∞—Å–∏–≤—ã–π loader
```

---

## üß™ –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. **–õ–æ–∫–∞–ª—å–Ω–æ (Development)**

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ FFmpeg —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:
```bash
ffmpeg -version
```

–ó–∞–ø—É—Å—Ç–∏—Ç–µ dev —Å–µ—Ä–≤–µ—Ä:
```bash
npm run dev
```

### 2. **–í Studio**
1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ (–¥–æ 4 –º–∏–Ω—É—Ç)
2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ
3. –ù–∞–∂–º–∏—Ç–µ **–≠–ö–°–ü–û–†–¢**
4. –ñ–¥–∏—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (~30-60 —Å–µ–∫—É–Ω–¥ –¥–ª—è 4 –º–∏–Ω—É—Ç)
5. MP4 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞—á–∞–µ—Ç—Å—è

### 3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞**
- –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π `.mp4` –≤ –ª—é–±–æ–º –ø–ª–µ–µ—Ä–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∞—É–¥–∏–æ –∏ —Ñ–æ—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (F12 ‚Üí Network ‚Üí —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª)

---

## üõ† Troubleshooting

### **"FFmpeg –Ω–µ –Ω–∞–π–¥–µ–Ω"**
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ FFmpeg:
```bash
# Windows (Chocolatey)
choco install ffmpeg

# macOS
brew install ffmpeg

# Linux
sudo apt install ffmpeg
```

### **"Export timeout exceeded"**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ FFmpeg —Ä–∞–±–æ—Ç–∞–µ—Ç: `ffmpeg -version`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ (–∫–æ–Ω—Å–æ–ª—å)
- –í–æ–∑–º–æ–∂–Ω–æ –∞—É–¥–∏–æ —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º —Ç—è–∂–µ–ª—ã–π

### **"–§–∞–π–ª –Ω–µ —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è"**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `Network` –≤ DevTools
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `GET /api/export/download?jobId=...` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞ –Ω–µ —É–¥–∞–ª–µ–Ω–∞ —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ **–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–º–∞–∫—Å 4 –º–∏–Ω)
- –í–∞–ª–∏–¥–∞—Ü–∏—è plan (`free` | `premium`)
- –¢–∞–π–º–∞—É—Ç—ã –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç (10 –º–∏–Ω)
- –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —ç–∫—Å–ø–æ—Ä—Ç–æ–≤ (2)

‚ö†Ô∏è **TODO (Production):**
- [ ] –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞)
- [ ] Rate limiting (–º–∞–∫—Å–∏–º—É–º —ç–∫—Å–ø–æ—Ä—Ç–æ–≤ –≤ —á–∞—Å)
- [ ] –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ç–æ–≤–æ–≥–æ MP4 –≤ R2 (–≤–º–µ—Å—Ç–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è)
- [ ] Webhook –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (–≤–º–µ—Å—Ç–æ polling)

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–¢–µ—Å—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ (4 –º–∏–Ω—É—Ç—ã –∞—É–¥–∏–æ):**
- Free (720p): ~30-40 —Å–µ–∫—É–Ω–¥
- Premium (1080p): ~50-60 —Å–µ–∫—É–Ω–¥

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É:**
- CPU: 2+ cores (–¥–ª—è FFmpeg)
- RAM: 1GB+ —Å–≤–æ–±–æ–¥–Ω–æ
- Disk: 500MB+ –≤—Ä–µ–º–µ–Ω–Ω–æ (–æ—á–∏—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —ç–∫—Å–ø–æ—Ä—Ç–∞)

---

## üöÄ Deploy

### **Cloudflare Pages**
–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Cloudflare Pages Functions.

**–í–∞–∂–Ω–æ:** Cloudflare Workers **–ù–ï** –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç `child_process` (FFmpeg).

**–†–µ—à–µ–Ω–∏—è:**
1. **Cloudflare Pages Functions** (—Ç–µ–∫—É—â–µ–µ)
2. **Separate API server** (Node.js –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º –¥–æ–º–µ–Ω–µ)
3. **Cloudflare Workers + Durable Objects** (–¥–ª—è –æ—á–µ—Ä–µ–¥–∏) + **External API** (–¥–ª—è FFmpeg)

### **Netlify Functions**
–†–∞–±–æ—Ç–∞–µ—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –Ω–æ –Ω—É–∂–Ω–æ:
1. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å `functions/` ‚Üí `netlify/functions/`
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å FFmpeg –≤ build environment
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `netlify.toml`

---

## üìù API Reference

### **POST /api/export**

–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É —ç–∫—Å–ø–æ—Ä—Ç–∞.

**Body (FormData):**
```json
{
  "audio": File,
  "photo": File,
  "duration": "240",
  "plan": "free" | "premium"
}
```

**Response (202 Accepted):**
```json
{
  "success": true,
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "queued",
  "message": "–≠–∫—Å–ø–æ—Ä—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å"
}
```

---

### **GET /api/export?jobId={id}**

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —ç–∫—Å–ø–æ—Ä—Ç–∞.

**Response:**
```json
{
  "jobId": "...",
  "status": "queued" | "processing" | "completed" | "failed",
  "plan": "free",
  "resolution": { "width": 1280, "height": 720 },
  "createdAt": 1234567890,
  "downloadUrl": "/api/export/download?jobId=..." // –µ—Å–ª–∏ completed
}
```

---

### **GET /api/export/download?jobId={id}**

–°–∫–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π MP4.

**Response:**
```
Content-Type: video/mp4
Content-Disposition: attachment; filename="toqibox-studio-{jobId}.mp4"
```

---

## ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å

- [x] –°–µ—Ä–≤–µ—Ä–Ω—ã–π FFmpeg —ç–∫—Å–ø–æ—Ä—Ç (MP4)
- [x] –û—á–µ—Ä–µ–¥—å —ç–∫—Å–ø–æ—Ä—Ç–æ–≤ (–º–∞–∫—Å 2 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
- [x] –õ–∏–º–∏—Ç—ã –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (4 –º–∏–Ω—É—Ç—ã)
- [x] –õ–∏–º–∏—Ç—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (720p / 1080p)
- [x] –¢–∞–π–º–∞—É—Ç—ã (10 –º–∏–Ω—É—Ç —ç–∫—Å–ø–æ—Ä—Ç, 15 –º–∏–Ω—É—Ç polling)
- [x] –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- [x] –ö—Ä–∞—Å–∏–≤—ã–π loader —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ StudioDesktop
- [ ] –ó–∞—Ö–≤–∞—Ç –∞–Ω–∏–º–∞—Ü–∏–∏ canvas (–ø–æ–∫–∞–¥—Ä–æ–≤–æ)
- [ ] Production deploy
- [ ] R2 upload –≥–æ—Ç–æ–≤—ã—Ö MP4
