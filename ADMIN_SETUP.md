# Настройка админ-панели

## 1. Создание таблиц в Supabase

Выполните SQL скрипты в Supabase SQL Editor:

1. `sql/create_admins_table.sql` - создает таблицу для администраторов (ОБЯЗАТЕЛЬНО!)
2. `sql/create_payments_table.sql` - создает таблицу для платежей
3. `sql/add_premium_fields_to_artists.sql` - добавляет поля премиума в таблицу artists

### 1.1. Добавление первого администратора

**ВАЖНО:** RLS политики требуют, чтобы пользователь уже был админом для добавления нового. Для первого админа используйте один из способов ниже:

#### Способ 1: Через Supabase Dashboard (РЕКОМЕНДУЕТСЯ - самый простой)

1. Откройте **Supabase Dashboard** → **Table Editor** → выберите таблицу `admins`
2. Нажмите кнопку **"Insert row"** (справа вверху)
3. Заполните поля:
   - `user_id`: вставьте ваш UUID (см. ниже как найти)
   - `email`: вставьте ваш email
   - `is_active`: поставьте галочку (true)
4. Нажмите **"Save"**

**Как найти YOUR_USER_ID:**
1. Войдите в приложение
2. Откройте консоль браузера (F12)
3. Выполните: `(await supabase.auth.getSession()).data.session.user.id`
4. Скопируйте полученный UUID

#### Способ 2: Через SQL (временно отключить RLS)

Выполните в Supabase SQL Editor (см. файл `sql/add_first_admin.sql`):

```sql
-- Отключаем RLS
ALTER TABLE public.admins DISABLE ROW LEVEL SECURITY;

-- Добавляем первого админа (ЗАМЕНИТЕ YOUR_USER_ID и email!)
INSERT INTO public.admins (user_id, email, is_active)
VALUES (
  'YOUR_USER_ID',  -- Замените на ваш UUID
  'your-email@example.com',  -- Замените на ваш email
  true
);

-- Включаем RLS обратно
ALTER TABLE public.admins ENABLE ROW LEVEL SECURITY;
```

## 2. Создание Storage бакета для скринов

В Supabase Dashboard:
1. Перейдите в Storage
2. Создайте новый бакет `payments`
3. Настройте политики:
   - **Public**: `true` (чтобы админ мог видеть скрины)
   - **File size limit**: 5MB
   - **Allowed MIME types**: `image/*`

## 3. Настройка RLS политик

Для админ-панели нужно разрешить чтение данных. Убедитесь, что политики RLS настроены правильно (они уже есть в SQL скриптах).

## 4. Получение пользователей

Админ-панель пытается получить пользователей через `supabase.auth.admin.listUsers()`, но это требует сервисный ключ.

**Альтернатива**: Используйте функцию в Supabase Edge Functions или создайте view в БД.

Или измените код в `src/app/admin/page.jsx`, чтобы получать пользователей через таблицу `artists` (связь через `user_id`).

## 5. Доступ к админ-панели

### Production:
Админ-панель доступна по адресу: `https://toqibox.win/admin`

### Локальная разработка:
Админ-панель доступна по адресу: `http://localhost:5174/admin`

**Важно**: 
- Админ-панель не требует входа, но для работы с данными нужны правильные RLS политики в Supabase
- Для локальной разработки может потребоваться временно отключить RLS или настроить политики для анонимного доступа
- В production обязательно добавьте проверку прав доступа (только для админов)!

## 6. Функционал админ-панели

- ✅ Просмотр всех пользователей (последний выделен)
- ✅ Просмотр всех артистов с информацией о премиуме
- ✅ Статистика (общее количество пользователей, артистов, премиум)
- ✅ Просмотр скринов оплаты
- ✅ Подтверждение платежей (автоматически включает премиум на 30 дней)
- ✅ Продление премиума (+7, +14, +21 день)
- ✅ Удаление пользователей и артистов
- ✅ Управление типами премиума (PREMIUM, PREMIUM+)

## 7. Поля премиума в таблице artists

После выполнения SQL скрипта в таблице `artists` появятся поля:
- `premium_type` - тип премиума: `'premium'`, `'premium_plus'` или `NULL`
- `premium_until` - дата окончания премиума (TIMESTAMPTZ)
- `verified` - есть ли верификация (золотая тюбетейка)
- `name_color` - цвет ника (только для премиум)

## 8. Автоматическая верификация

При подтверждении платежа автоматически устанавливается `verified = true`, что дает артисту:
- Золотую тюбетейку (verifgold.svg)
- Надпись "Проверенный Артист"
- Доступ к премиум функциям

